# DevSecOps2-Challenge Jenkins Pipeline

This repository contains the Jenkins pipeline configuration for the **DevSecOps2-Challenge** application. The pipeline automates the process of building, testing, scanning, and deploying the application to development and production Kubernetes environments with a full DevSecOps workflow.

---

## Table of Contents

- [Overview](#overview)  
- [Pipeline Stages](#pipeline-stages)  
- [Prerequisites](#prerequisites)  
- [Setup Instructions](#setup-instructions)  
- [Usage](#usage)  
- [Notifications](#notifications)  
- [Troubleshooting](#troubleshooting)  

---

## Overview

This Jenkins pipeline is designed to:

- Checkout source code from GitHub  
- Build and test using Maven  
- Perform SonarQube static code analysis and enforce quality gates  
- Build and push Docker images to a private Nexus registry  
- Scan Docker images with Trivy for security vulnerabilities  
- Collect and archive Trivy vulnerability and config audit reports from Kubernetes  
- Deploy the application to Kubernetes development and production namespaces via Helm  
- Provide manual approval before production deployment  
- Notify stakeholders via email on success or failure  

---

## Pipeline Stages

1. **Checkout**  
   Clone the repository from GitHub using secured credentials.

2. **Build & Test**  
   Run Maven `clean verify` to build and test the application (integration tests are skipped).

3. **SonarQube Analysis**  
   Run SonarQube analysis to inspect code quality and security issues.

4. **Quality Gate**  
   Wait up to 2 minutes for SonarQube quality gate results and abort if gate fails.

5. **Build & Push Image**  
   Build a Docker image tagged with the current Git commit short hash and push it to a Nexus Docker registry.

6. **Trivy Image Scan**  
   Scan the pushed image with Trivy to detect HIGH and CRITICAL vulnerabilities.

7. **Collect Trivy Reports**  
   Retrieve and archive Kubernetes vulnerability and config audit reports generated by Trivy operator.

8. **Deploy to DEV**  
   Deploy or upgrade the Helm release in the `dev` namespace.

9. **Approval to PROD**  
   Wait for manual confirmation to deploy to production.

10. **Deploy to PROD**  
    Deploy or upgrade the Helm release in the `prod` namespace.

---

## Prerequisites

- Jenkins agent with Docker and Maven installed  
- Jenkins credentials configured for:  
  - GitHub HTTPS access (`git-https`)  
  - SonarQube token (`sonar-token`)  
  - Nexus Docker registry (`nexus-cred`)  
- SonarQube server configured in Jenkins with the name `SonarQube`  
- Nexus Docker registry reachable at `10.25.157.175:32030`  
- Trivy CLI installed on Jenkins agent  
- Kubernetes cluster with namespaces `dev`, `prod`, and `trivy-system` configured  
- Helm CLI installed and configured with access to the Kubernetes cluster  
- Helm chart located in the `chart` directory at the repo root

---

## Setup Instructions

1. **Configure Jenkins Credentials:**  
   - Add GitHub credentials (`git-https`)  
   - Add SonarQube token (`sonar-token`)  
   - Add Nexus Docker registry credentials (`nexus-cred`)  

2. **Install Required Tools on Jenkins Agent:**  
   - Docker (with `--security-opt seccomp=unconfined` permission)  
   - Maven  
   - Trivy CLI  
   - Helm CLI  

3. **Configure Jenkins:**  
   - Add SonarQube server configuration with name `SonarQube`  
   - Create a Jenkins Pipeline job using this pipeline script

4. **Update Pipeline Environment Variables:**  
   Adjust these if your environment differs:  
   ```groovy
   APP_NAME      = 'devsecops2-challenge'
   REGISTRY_HOST = '10.25.157.175:32030'
   IMAGE_ROOT    = "${REGISTRY_HOST}/docker-hosted"
5. **Done! The setup is ready to use**
