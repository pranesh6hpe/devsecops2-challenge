pipeline {
  agent { label 'jenkins-agent' }

  environment {
    APP_NAME      = 'devsecops2-challenge'
    REGISTRY_HOST = '10.25.157.175:32030'
    IMAGE_ROOT    = "${REGISTRY_HOST}/docker-hosted"
  }

  stages {
    stage('Checkout') {
      steps {
        echo "üîç Checking out source from Git"
        git url:           'https://github.com/pranesh6hpe/devsecops2-challenge.git',
            branch:        'main',
            credentialsId: 'git-https'
        echo "‚úÖ Checkout complete"
      }
    }

    stage('Build & Test') {
      steps {
        echo "üõ† Building and running unit tests"
        sh 'mvn clean verify -DskipITs'
        echo "‚úÖ Build & Test successful"
      }
    }

    stage('SonarQube Analysis') {
      steps {
        echo "üîé Starting SonarQube analysis"
        withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
          withSonarQubeEnv('SonarQube') {
            sh '''
              mvn sonar:sonar \
                -Dsonar.projectKey=${APP_NAME} \
                -Dsonar.token=${SONAR_TOKEN}
            '''
          }
        }
        echo "‚úÖ SonarQube scan triggered"
      }
    }

    stage('Quality Gate') {
      steps {
        echo "‚è± Waiting for SonarQube quality gate"
        timeout(time: 2, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
        echo "‚úÖ Quality gate passed"
      }
    }

    stage('Build & Push Image') {
      steps {
        script {
          env.IMAGE_TAG = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          env.IMAGE     = "${IMAGE_ROOT}/${APP_NAME}:${IMAGE_TAG}"
          echo "üñº  Will build image: ${IMAGE}"

          withCredentials([usernamePassword(
            credentialsId: 'nexus-cred',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PW'
          )]) {
            echo "üõ†  Building Docker image"
            sh 'docker build --security-opt seccomp=unconfined -t "$IMAGE" .'

            echo "üîê  Logging into Nexus registry"
            sh 'echo "$NEXUS_PW" | docker login --tls-verify=false --username "$NEXUS_USER" --password-stdin ${REGISTRY_HOST}'

            echo "üì§  Pushing image to Nexus"
            sh 'docker push --tls-verify=false "$IMAGE"'
          }

          echo "‚úÖ Image build & push complete"
        }
      }
    }

    stage('Trivy Image Scan') {
      steps {
        echo "üîé Starting Trivy vulnerability scan"
        script {
          withCredentials([usernamePassword(
            credentialsId: 'nexus-cred',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PW'
          )]) {
            sh '''
              IMAGE=${IMAGE_ROOT}/${APP_NAME}:${IMAGE_TAG}
              trivy image \
                --username  "$NEXUS_USER" \
                --password  "$NEXUS_PW" \
                --insecure \
                --ignore-unfixed \
                --severity HIGH,CRITICAL \
                --exit-code 1 \
                "$IMAGE"
            '''
          }
        }
        echo "‚úÖ Trivy scan complete"
      }
    }

    stage('Collect Trivy Reports') {
      steps {
        echo "üìÑ Collecting Trivy operator reports"
        sh '''
          kubectl -n trivy-system get vulnerabilityreports.aquasecurity.github.io -o yaml > vulnerability-reports.yaml
          kubectl -n trivy-system get configauditreports.aquasecurity.github.io -o yaml   > configaudit-reports.yaml
          kubectl -n dev get vulnerabilityreports.aquasecurity.github.io -o yaml          >> vulnerability-reports.yaml || true
          kubectl -n dev get configauditreports.aquasecurity.github.io -o yaml            >> configaudit-reports.yaml    || true

          echo '---' > combined-trivy-report.yaml
          cat vulnerability-reports.yaml   >> combined-trivy-report.yaml
          echo '---'                      >> combined-trivy-report.yaml
          cat configaudit-reports.yaml    >> combined-trivy-report.yaml
        '''
        archiveArtifacts artifacts: '*.yaml', fingerprint: true
        echo "‚úÖ Trivy reports archived"
      }
    }

    stage('Deploy to DEV') {
      steps {
        echo "üöÄ Deploying to DEV namespace"
        sh '''
          helm upgrade --install "${APP_NAME}" chart \
            --namespace dev --create-namespace \
            --set image.repository=${IMAGE_ROOT}/${APP_NAME} \
            --set image.tag=${IMAGE_TAG} \
            --set imagePullSecrets[0].name=nexus-pull \
            --set service.type=NodePort \
            --set service.nodePort=32007
        '''
        echo "‚úÖ Deployed to DEV"
      }
    }

    stage('DAST with ZAP (AI-Powered)') {
      steps {
        echo "üïµ Starting DAST with OWASP ZAP + AI add-on"
        script {
          withCredentials([usernamePassword(
            credentialsId: 'nexus-cred',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PW'
          )]) {
            echo "üîê Authenticating to Nexus for ZAP image pull"
            sh 'echo "$NEXUS_PW" | docker login --tls-verify=false --username "$NEXUS_USER" --password-stdin ${REGISTRY_HOST}'

            echo "‚¨á Pulling and running ZAP container"
            sh '''
              docker run --rm --entrypoint="" \
                owasp/zap2docker-stable:latest \
                zap-full-scan.py -addoninstall aipscan \
                  -t http://${APP_NAME}.dev.svc.cluster.local:8080 \
                  -r zap-report.html
            '''
          }
        }
        echo "‚úÖ DAST scan finished"
      }
      post {
        always {
          echo "üì¶ Archiving ZAP report"
          archiveArtifacts artifacts: 'zap-report.html', fingerprint: true
        }
        failure {
          echo "‚ùå ZAP DAST scan encountered errors ‚Äî check zap-report.html"
        }
      }
    }

    stage('Approval to PROD') {
      steps {
        echo "üîî Awaiting manual approval to PROD"
        input message: "Deploy ${APP_NAME}:${IMAGE_TAG} to PROD?"
      }
    }

    stage('Deploy to PROD') {
      steps {
        echo "üöÄ Deploying to PROD namespace"
        sh '''
          helm upgrade --install "${APP_NAME}" chart \
            --namespace prod --create-namespace \
            --set image.repository=${IMAGE_ROOT}/${APP_NAME} \
            --set image.tag=${IMAGE_TAG} \
            --set imagePullSecrets[0].name=nexus-pull \
            --set service.type=NodePort \
            --set service.nodePort=32008
        '''
        echo "‚úÖ Deployed to PROD"
      }
    }
  }

  post {
    always {
      echo "üßπ Cleaning up workspace"
      cleanWs()
    }
    success {
      echo "üì¨ Sending success email"
      script {
        def gitEmail = env.GIT_COMMITTER_EMAIL ?: 'default-team@example.com'
        mail to: gitEmail,
             subject: "${env.JOB_NAME} #${env.BUILD_NUMBER} SUCCESS ‚úÖ",
             body: "Good news! Build succeeded. See ${env.BUILD_URL}"
      }
    }
    failure {
      echo "üì¨ Sending failure email"
      script {
        def gitEmail = env.GIT_COMMITTER_EMAIL ?: 'default-team@example.com'
        mail to: gitEmail,
             subject: "${env.JOB_NAME} #${env.BUILD_NUMBER} FAILED ‚ùå",
             body: "Build failed. Check console output: ${env.BUILD_URL}"
      }
    }
  }
}
