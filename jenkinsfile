/**
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  DevSecOps-2  Â·  Jenkinsfile
 *  â€¢ builds + tests with Maven
 *  â€¢ containerises the JAR
 *  â€¢ pushes the image to Nexus (HTTP, port 32030)
 *  â€¢ deploys to the devsecops2 namespace with Helm
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 */

pipeline {
  /------------------------------------------------------------/
  agent { label 'jenkins-agent' }
  /------------------------------------------------------------/
  environment {
    APP_NAME      = 'devsecops2-challenge'

    /* Nexus Docker registry (HTTP) */
    REGISTRY_HOST = '10.25.157.175:32030'
    IMAGE_ROOT    = "${REGISTRY_HOST}/docker-hosted"
  }
  /------------------------------------------------------------/
  stages {

    /* 1 â”€ Checkout code ---------------------------------------*/
    stage('Checkout') {
      steps {
        git url: 'https://github.com/pranesh6hpe/devsecops2-challenge.git',
            branch: 'main',
            credentialsId: 'git-https'
      }
    }

    /* 2 â”€ Build & unit-test ----------------------------------*/
    stage('Build & Test') {
      steps { sh 'mvn clean verify -DskipITs' }
    }

    /* 3 â”€ Build image & push to Nexus ------------------------*/
    stage('Build & Push Image') {
      steps {
        script {
          /* short SHA tag */
          env.IMAGE_TAG = sh(
            returnStdout: true,
            script: 'git rev-parse --short HEAD'
          ).trim()
          env.IMAGE = "${IMAGE_ROOT}/${APP_NAME}:${IMAGE_TAG}"

          /* login & push without Groovy interpolation warnings */
          withCredentials([usernamePassword(
            credentialsId: 'nexus-cred',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PW'
          )]) {
            sh '''
              echo "ğŸ›   Building $IMAGE"
              docker build -t "$IMAGE" .

              echo "ğŸ”  Logging into Nexus Docker registry"
              echo "$NEXUS_PW" | docker login --tls-verify=false \
                   --username "$NEXUS_USER" --password-stdin "$REGISTRY_HOST"

              echo "ğŸ“¤  Pushing $IMAGE"
              docker push --tls-verify=false "$IMAGE"
            '''
          }
        }
      }
    }

    /* 4 â”€ Deploy to DEV with Helm ----------------------------*/
    stage('Deploy to DEV') {
      steps {
        sh '''
          echo "ğŸš€  helm upgrade --install $APP_NAME (tag $IMAGE_TAG)"
          helm upgrade --install "$APP_NAME" chart \
            --namespace devsecops2 \
            --set image.repository=$IMAGE_ROOT/$APP_NAME \
            --set image.tag=$IMAGE_TAG
        '''
      }
    }
  }
  /------------------------------------------------------------/
  post { always { cleanWs() } }
}
