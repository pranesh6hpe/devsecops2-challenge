pipeline {
  agent { label 'jenkins-agent' }

  environment {
    APP_NAME = 'devsecops2-challenge'
    REGISTRY = '10.25.157.175:32003/docker-hosted'
  }

  stages {
    stage('Checkout') {
      steps {
        git(
          url: 'https://github.com/pranesh6hpe/devsecops2-challenge.git',
          branch: 'main',
          credentialsId: 'git-https'
        )
      }
    }

    stage('Build & Test') {
      agent {
        docker {
          image 'maven:3.9.7-eclipse-temurin-21-alpine'
          // run as root so workspace permissions line up
          args  '-u root:root -v $HOME/.m2:/root/.m2'
          // reuse the checked-out workspace mount
          reuseNode true 
        }
      }
      steps {
        sh 'mvn clean verify -DskipITs'
      }
    }

    stage('Build & Push Image') {
      steps {
        script {
          def commit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          def image  = "${REGISTRY}/${APP_NAME}:${commit}"
          withCredentials([usernamePassword(
            credentialsId: 'nexus-cred',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PW'
          )]) {
            sh """
              docker build -t ${image} .
              echo "${NEXUS_PW}" | docker login --username "${NEXUS_USER}" --password-stdin ${REGISTRY}
              docker push ${image}
            """
          }
        }
      }
    }

    stage('Deploy to DEV') {
      steps {
        sh """
          helm upgrade --install ${APP_NAME} chart \
            --namespace devsecops2 \
            --set image.repository=${REGISTRY}/${APP_NAME} \
            --set image.tag=${env.BUILD_NUMBER}
        """
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
