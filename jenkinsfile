pipeline {
  agent { label 'jenkins-agent' }

  environment {
    APP_NAME      = 'devsecops2-challenge'
    REGISTRY_HOST = '10.25.157.175:32030'
    IMAGE_ROOT    = "${REGISTRY_HOST}/docker-hosted"
  }

  stages {
    stage('Checkout') {
      steps {
        git(
          url:           'https://github.com/pranesh6hpe/devsecops2-challenge.git',
          branch:        'main',
          credentialsId: 'git-https'
        )
      }
    }

    stage('Build & Test') {
      steps {
        sh 'mvn clean verify -DskipITs'
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withCredentials([string(
          credentialsId: 'sonar-token',
          variable:      'SONAR_TOKEN'
        )]) {
          withSonarQubeEnv('SonarQube') {
            // actually run the scanner
            sh """\
              mvn sonar:sonar \
                -Dsonar.projectKey=${APP_NAME} \
                -Dsonar.login=${SONAR_TOKEN}
            """
          }
        }
      }
    }

    stage('Quality Gate') {
      // abortPipeline: true will fail the build if quality gate is not passed
      steps {
        timeout(time: 2, unit: 'MINUTES') {
          waitForQualityGate abortPipeline: true
        }
      }
    }

    stage('Build & Push Image') {
      steps {
        script {
          env.IMAGE_TAG = sh(
            returnStdout: true,
            script: 'git rev-parse --short HEAD'
          ).trim()
          env.IMAGE = "${IMAGE_ROOT}/${APP_NAME}:${IMAGE_TAG}"

          withCredentials([usernamePassword(
            credentialsId: 'nexus-cred',
            usernameVariable: 'NEXUS_USER',
            passwordVariable: 'NEXUS_PW'
          )]) {
            sh '''\
              echo "üõ†  Building $IMAGE"
              docker build --security-opt seccomp=unconfined -t "$IMAGE" .

              echo "üîê  Logging into Nexus"
              echo "$NEXUS_PW" | docker login --tls-verify=false \
                   --username "$NEXUS_USER" --password-stdin "$REGISTRY_HOST"

              echo "üì§  Pushing $IMAGE"
              docker push --tls-verify=false "$IMAGE"
            '''
          }
        }
      }
    }

    stage('Trivy Image Scan') {
  steps {
    script {
      withCredentials([usernamePassword(
        credentialsId: 'nexus-cred',
        usernameVariable: 'NEXUS_USER',
        passwordVariable: 'NEXUS_PW'
      )]) {
        sh '''
          IMAGE=${IMAGE_ROOT}/${APP_NAME}:${IMAGE_TAG}

          # Make sure we can fetch remote manifest
          export TRIVY_USERNAME=$NEXUS_USER
          export TRIVY_PASSWORD=$NEXUS_PW

          trivy image --remote \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            --skip-update \
            "$IMAGE"
        '''
      }
    }
  }
}


    stage('Deploy to DEV') {
      steps {
        sh '''\
          echo "üöÄ  helm upgrade --install $APP_NAME (tag $IMAGE_TAG)"
          helm upgrade --install "$APP_NAME" chart \
            --namespace devsecops2 \
            --set image.repository=$IMAGE_ROOT/$APP_NAME \
            --set image.tag=$IMAGE_TAG \
            --set imagePullSecrets[0].name=nexus-pull
        '''
      }
    }
  }

  post { 
    always { cleanWs() }
  }
}
